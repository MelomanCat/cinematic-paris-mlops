name: Cinematic Paris CI/CD

on:
  push:
    branches: [ main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install deps
      run: pip install -r requirements.txt

    - name: Run tests
      run: |
        export PYTHONPATH="$GITHUB_WORKSPACE"
        pytest -v

    # --- CD (runs only if tests passed)
    - name: Configure AWS
      run: |
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
        echo "AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}" >> $GITHUB_ENV

    - name: Build inference API
      run: docker build -t cinematic-inference ./inference_api

    - name: Smoke test inference API
      run: |
        docker run -d --name inference-test -p 7860:7860 \
          -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}" \
          -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}" \
          -e AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION}" \
          cinematic-inference

        READY=0
        for i in {1..30}; do
          if curl -fsS http://localhost:7860/health > /dev/null; then
            echo "API is up!"
            READY=1
            break
          fi
          echo "Waiting for API... ($i/30)"
          sleep 2
        done

        echo "---- container logs ----"
        docker logs inference-test || true
        echo "------------------------"

        docker stop inference-test || true
        docker rm inference-test || true

        if [ "$READY" -ne 1 ]; then
          echo "API did not start in time ‚ùå"
          exit 1
        fi

    - name: Install Hugging Face CLI
      run: |
        python -m pip install --upgrade pip
        python -m pip install -U "huggingface_hub[cli]"
        python -m pip show huggingface_hub
        python -m pip list | grep huggingface || true
        which huggingface-cli || true
        which hf || true

    - name: Login to HuggingFace
      run: hf auth login --token "${{ secrets.HF_TOKEN }}" --add-to-git-credential

    - name: Push to HF Space
      run: |
        rm -rf cinematic-inference
        git clone https://huggingface.co/spaces/jedha0padavan/cinematic-inference cinematic-inference

        rsync -av --delete inference_api/ cinematic-inference/

        cd cinematic-inference
        git add .
        git config user.email "actions@github.com"
        git config user.name "github-actions"

        git commit -m "Auto deploy new Production model" || echo "No changes to commit"
        git push